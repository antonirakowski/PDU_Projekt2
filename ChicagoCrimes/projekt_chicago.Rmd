---
output:
  pdf_document: default
  html_document: default
---
```{r}
#Cleanup
rm(list=ls())
gc()
#Preperaing the data
library(dplyr)

# Weather from chicago between 2000 and 2024 hourly
weather <- read.csv("weather_chicago_2001_2023.csv")

# Crimes from Chicago, from 2001 to 2023
# Deleting unnesessary columns from crimes (location etc.)
#crimes[,c(13:22)] <- NULL
# modified crimes without locations data
crimes <- read.csv("crimes_chicago_mod.csv.gz")

# Creating usefull columns, then join
crimes <- crimes %>%
  mutate(Date = format(as.POSIXct(Date, format = "%m/%d/%Y %I:%M:%S %p"), "%Y-%m-%dT%H:%M:%S"),
         Hour = round((as.integer(substr(Date, 12, 13)) * 3600 +
                         as.integer(substr(Date, 15, 16)) * 60 +
                         as.integer(substr(Date, 18, 19))) %/% 3600), #rouding time to just hour to match weather$time
         Date = sprintf("%sT%02d%s",substr(Date, 1, 10), Hour, ":00")) %>% 
  right_join(weather, by = join_by(Date==time))
# right join, because for now it's better to keep the days when no crime happens
```


```{r}
# Differet types of crimes should be analised separately

count_list <- list()
for(i in unique(crimes$Primary.Type)){
  count_list[[i]] <- sum(crimes$Primary.Type == i, na.rm=TRUE)
}
count_list_sorted <- count_list[order(unlist(count_list), decreasing = TRUE)]
types <- names(count_list_sorted)
counts <- unlist(count_list_sorted)
# Create a bar plot

barplot(counts, names.arg = types, las = 2, col = ifelse(counts<mean(counts),"red","skyblue"),
        main = "Counts of Crime Types", xlab = "Crime Types", ylab = "Count")

```


```{r}
#plotting for each crime type

crime_types <- names(count_list_sorted)[1:20]

number_of_day_in_year <- as.POSIXlt(substr(crimes$Date,1,10), format = "%Y-%m-%d")$yday
cut_min <- 0.05
cut_max <- 1

for(crimeType in crime_types){
  df <- crimes %>%
    mutate(Date = number_of_day_in_year %/% 14) %>%
    filter(Primary.Type == crimeType) %>%
    group_by(Date)%>%
    summarise(mean_temp = mean(temperature_2m...C.),
              mean_wind = mean(wind_speed_10m..km.h.),
              mean_precipitation = mean(precipitation..mm.),
              mean_cloud = mean(cloud_cover....),
              count = n()) %>%
    filter(between(count, quantile(count, c(cut_min, cut_max))[[1]],quantile(count, c(cut_min, cut_max))[[2]])) %>%
    filter(between(mean_temp, quantile(mean_temp, c(cut_min, cut_max))[[1]],quantile(mean_temp, c(cut_min, cut_max))[[2]]))
  
  var_cor <- df$mean_temp
  
  title <- sprintf("crime type: %s rows: %d cor = %f", 
                   crimeType, dim(df)[1], cor(var_cor, df$count, method = "pearson"))
  print(title)
  if(dim(df)[1]!=0){
    plot(var_cor, df$count,las=2, main = title, type="p", pch=16, col=rgb(0,0,0,0.3))
    #plot(df$Date, df$count, main = paste(crimeType,"in year"), type="l", pch=16, col=rgb(0,0,0,0.3))
  }
}
```

Testing NARCOTICS

```{r}

number_of_day_in_year <- as.POSIXlt(substr(crimes$Date,1,10), format = "%Y-%m-%d")$yday
cut_min <- 0.05
cut_max <- 0.95

crimeType <- "NARCOTICS"

library(stringr)

crimes <- crimes %>%
  mutate(Description = case_when(
    Primary.Type == crimeType & str_detect(Description, "POSS") ~ "POSSESS",
    Primary.Type == crimeType & (str_detect(Description, "DELIVER") | str_detect(Description, "MANU")) ~ "MANU/DELIVER",
    TRUE ~ Description
  ))

df_Possess <- crimes %>%
    mutate(Date = number_of_day_in_year %/% 7) %>%
    filter(Primary.Type == crimeType) %>%
    filter(Description == "POSSESS") %>%
    group_by(Date)%>%
    summarise(mean_temp = mean(temperature_2m...C.),
              mean_wind = mean(wind_speed_10m..km.h.),
              mean_precipitation = mean(precipitation..mm.),
              mean_cloud = mean(cloud_cover....),
              count = n()) %>%
    filter(between(count, 
                   quantile(count, c(cut_min, cut_max))[[1]], 
                   quantile(count, c(cut_min, cut_max))[[2]])) %>%
    filter(between(mean_temp, 
                   quantile(mean_temp, c(cut_min, cut_max))[[1]],
                   quantile(mean_temp, c(cut_min, cut_max))[[2]]))

df_ManuDeliver <- crimes %>%
    mutate(Date = number_of_day_in_year %/% 7) %>%
    filter(Primary.Type == crimeType) %>%
    filter(Description == "MANU/DELIVER") %>%
    group_by(Date)%>%
    summarise(mean_temp = mean(temperature_2m...C.),
              mean_wind = mean(wind_speed_10m..km.h.),
              mean_precipitation = mean(precipitation..mm.),
              mean_cloud = mean(cloud_cover....),
              count = n()) %>%
    filter(between(count, 
                   quantile(count, c(cut_min, cut_max))[[1]], 
                   quantile(count, c(cut_min, cut_max))[[2]])) %>%
    filter(between(mean_temp, 
                   quantile(mean_temp, c(cut_min, cut_max))[[1]],
                   quantile(mean_temp, c(cut_min, cut_max))[[2]]))

df_Other <- crimes %>%
    mutate(Date = number_of_day_in_year %/% 7) %>%
    filter(Primary.Type == crimeType) %>%
    filter(Description != "MANU/DELIVER" & Description != "POSSESS") %>%
    group_by(Date)%>%
    summarise(mean_temp = mean(temperature_2m...C.),
              mean_wind = mean(wind_speed_10m..km.h.),
              mean_precipitation = mean(precipitation..mm.),
              mean_cloud = mean(cloud_cover....),
              count = n()) %>%
    filter(between(count, 
                   quantile(count, c(cut_min, cut_max))[[1]], 
                   quantile(count, c(cut_min, cut_max))[[2]])) %>%
    filter(between(mean_temp, 
                   quantile(mean_temp, c(cut_min, cut_max))[[1]],
                   quantile(mean_temp, c(cut_min, cut_max))[[2]]))

title <- sprintf("Different NARCOTICS crimes cor1 = %f cor2 = %f cor3 = %f", 
                 cor(df_Possess$mean_temp, df_Possess$count, method = "pearson"),
                 cor(df_ManuDeliver$mean_temp, df_ManuDeliver$count, method = "pearson"),
                 cor(df_Other$mean_temp, df_Other$count, method = "pearson"))

print(title)



plot(df_Possess$mean_temp, df_Possess$count, main = title, type="p", pch=16, col=rgb(1,0,0,1))
#lines(df_Possess$mean_temp, df_ManuDeliver$count, main = title, type="p", pch=16, col=rgb(0,0,1,1))
#lines(df_Possess$mean_temp, df_Other$count, main = title, type="p", pch=16, col=rgb(0,1,0,1))

# do poprawy?
#ggplot(data.frame(df_Possess$count, df_ManuDeliver$count, df_Possess$Date))
```



Testing HOMICIDEs

```{r}

number_of_day_in_year <- as.POSIXlt(substr(crimes$Date,1,10), format = "%Y-%m-%d")$yday
cut_min <- 0.05
cut_max <- 1

crimeType <- "HOMICIDE"

print(unique(unlist(crimes %>% filter(Primary.Type == crimeType) %>% select(Description))))

df_Homicide <- crimes %>%
    mutate(Date = number_of_day_in_year %/% 14) %>%
    filter(Primary.Type == crimeType) %>%
    filter(Description == "FIRST DEGREE MURDER") %>%
    group_by(Date)%>%
    summarise(mean_temp = mean(temperature_2m...C.),
              mean_wind = mean(wind_speed_10m..km.h.),
              #mean_precipitation = mean(precipitation..mm.),
              mean_cloud = mean(cloud_cover....),
              #mean_humidity = mean(relative_humidity_2m....),
              #mean_sur_pressure = mean(surface_pressure..hPa.),
              count = n()) %>%
    filter(between(count, 
                   quantile(count, c(cut_min, cut_max))[[1]], 
                   quantile(count, c(cut_min, cut_max))[[2]])) %>%
    filter(
      between(mean_temp, quantile(mean_temp, c(cut_min, cut_max))[1], quantile(mean_temp, c(cut_min, cut_max))[2]) &
      between(mean_wind, quantile(mean_wind, c(cut_min, cut_max))[1], quantile(mean_wind, c(cut_min, cut_max))[2]) &
      #between(mean_precipitation, quantile(mean_precipitation, c(cut_min, cut_max))[1], quantile(mean_precipitation, c(cut_min, cut_max))[2]) &
      between(mean_cloud, quantile(mean_cloud, c(cut_min, cut_max))[1], quantile(mean_cloud, c(cut_min, cut_max))[2]) 
      #& between(mean_humidity, quantile(mean_humidity, c(cut_min, cut_max))[1], quantile(mean_humidity, c(cut_min, cut_max))[2]) &
      #between(mean_sur_pressure, quantile(mean_sur_pressure, c(cut_min, cut_max))[1], quantile(mean_sur_pressure, c(cut_min, cut_max))[2])
  )

# Normalizing 
normalize <- function(x) {
  return((x - min(x)) / (max(x) - min(x)))
}

df_Homicide_normalized <- as.data.frame(lapply(df_Homicide, normalize))
df_Homicide_standardized <- scale(df_Homicide)
write.csv(df_Homicide_normalized, "df_Homicide_normalized.csv", row.names = FALSE)
write.csv(df_Homicide_standardized, "df_Homicide_standardized.csv", row.names = FALSE)

dim(df_Homicide)
for (i in colnames(df_Homicide_normalized)[2:4]){
  title <- sprintf("%s:%s | %s , cor = %f", 
                   crimeType, "FIRST DEGREE MURDER", i, 
                 cor(df_Homicide_normalized[i], df_Homicide_normalized$count, method = "pearson"))
  print(title)
  plot(df_Homicide_normalized[[i]], df_Homicide_normalized$count, 
       las=2, main = title, type="p", pch=16, col=rgb(0,0,0,0.3))
}


```